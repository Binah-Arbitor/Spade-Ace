name: ðŸŒ Offline APK Builder

# This workflow can build APKs without internet connectivity by using cached dependencies
# It's designed for environments with restricted or unreliable network access

on:
  workflow_dispatch:
    inputs:
      use_cached_deps:
        description: 'Use previously cached dependencies'
        required: false
        default: true
        type: boolean

env:
  GRADLE_OPTS: '-Dorg.gradle.daemon=false -Dorg.gradle.parallel=false -Dorg.gradle.configureondemand=false'

jobs:
  offline-build:
    name: ðŸŒ Offline Build
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v3

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ðŸ—‚ï¸ Restore Gradle cache
        if: ${{ github.event.inputs.use_cached_deps == 'true' }}
        uses: actions/cache/restore@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-offline-${{ hashFiles('**/*.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-gradle-offline-
            ${{ runner.os }}-gradle-

      - name: ðŸ”§ Setup offline build environment
        run: |
          echo "ðŸ”§ Setting up offline build environment..."
          
          # Make gradlew executable
          chmod +x gradlew
          
          # Configure Gradle for offline mode
          mkdir -p ~/.gradle
          cat > ~/.gradle/gradle.properties << EOF
          org.gradle.daemon=false
          org.gradle.parallel=false
          org.gradle.configureondemand=false
          org.gradle.offline=true
          org.gradle.caching=true
          EOF
          
          # Create local.properties for Android if needed
          cat > local.properties << EOF
          sdk.dir=/usr/local/lib/android/sdk
          ndk.dir=/usr/local/lib/android/sdk/ndk-bundle
          EOF

      - name: ðŸ§ª Test offline capabilities
        run: |
          echo "ðŸ§ª Testing offline build capabilities..."
          
          # First try offline mode
          if ./gradlew --offline dependencies --no-daemon; then
            echo "âœ… Offline dependencies available"
            echo "OFFLINE_BUILD_POSSIBLE=true" >> $GITHUB_ENV
          else
            echo "âš ï¸ Offline dependencies not available, will try minimal online mode"
            echo "OFFLINE_BUILD_POSSIBLE=false" >> $GITHUB_ENV
          fi

      - name: ðŸ—ï¸ Build APKs (offline mode)
        if: env.OFFLINE_BUILD_POSSIBLE == 'true'
        run: |
          echo "ðŸ—ï¸ Building APKs in offline mode..."
          
          ./gradlew clean --offline --no-daemon
          
          # Build debug APK
          if ./gradlew assembleDebug --offline --no-daemon --stacktrace; then
            echo "âœ… Debug APK built offline"
          else
            echo "âŒ Debug APK build failed"
          fi
          
          # Build release APK  
          if ./gradlew assembleRelease --offline --no-daemon --stacktrace; then
            echo "âœ… Release APK built offline"
          else
            echo "âŒ Release APK build failed"
          fi

      - name: ðŸŒ Build APKs (minimal online mode)
        if: env.OFFLINE_BUILD_POSSIBLE == 'false'
        run: |
          echo "ðŸŒ Attempting minimal online build..."
          
          # Configure for minimal network usage
          echo "org.gradle.offline=false" >> ~/.gradle/gradle.properties
          
          # Try to build with minimal network access
          for attempt in 1 2 3; do
            echo "Build attempt $attempt/3..."
            
            if ./gradlew clean assembleDebug assembleRelease --no-daemon --stacktrace; then
              echo "âœ… APKs built successfully"
              break
            else
              if [ $attempt -eq 3 ]; then
                echo "âŒ All build attempts failed"
                exit 1
              fi
              echo "â³ Retrying in 30 seconds..."
              sleep 30
            fi
          done

      - name: ðŸ“¦ Package offline APKs
        if: always()
        run: |
          echo "ðŸ“¦ Packaging APKs for offline build..."
          
          mkdir -p offline_outputs
          
          # Copy debug APK
          if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
            cp "app/build/outputs/apk/debug/app-debug.apk" "offline_outputs/SpadeAce-offline-debug.apk"
            echo "âœ… Debug APK packaged"
          fi
          
          # Copy release APK
          if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
            cp "app/build/outputs/apk/release/app-release.apk" "offline_outputs/SpadeAce-offline-release.apk"
            echo "âœ… Release APK packaged"
          fi
          
          # Generate checksums
          cd offline_outputs
          for apk in *.apk; do
            if [ -f "$apk" ]; then
              sha256sum "$apk" > "${apk}.sha256"
              echo "Checksum created for $apk"
            fi
          done
          cd ..
          
          # Create build info
          cat > offline_outputs/offline-build-info.txt << EOF
          Offline APK Builder Results
          ==========================
          Build Mode: ${{ env.OFFLINE_BUILD_POSSIBLE == 'true' && 'Full Offline' || 'Minimal Online' }}
          Build Time: $(date -u)
          Commit: ${{ github.sha }}
          
          $(ls -la offline_outputs/)
          EOF

      - name: ðŸ’¾ Save dependencies for future offline builds
        if: env.OFFLINE_BUILD_POSSIBLE == 'false'
        uses: actions/cache/save@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-offline-${{ hashFiles('**/*.gradle*') }}

      - name: ðŸ“¤ Upload offline APKs
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: SpadeAce-Offline-APKs
          path: offline_outputs/
          retention-days: 60

      - name: ðŸ“Š Offline build summary
        if: always()
        run: |
          echo "# ðŸŒ Offline APK Builder Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Mode**: ${{ env.OFFLINE_BUILD_POSSIBLE == 'true' && 'Full Offline âœ…' || 'Minimal Online âš ï¸' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if ls offline_outputs/*.apk 1> /dev/null 2>&1; then
            echo "## Generated APKs:" >> $GITHUB_STEP_SUMMARY
            for apk in offline_outputs/*.apk; do
              if [ -f "$apk" ]; then
                SIZE=$(stat -c%s "$apk" 2>/dev/null || echo "0")
                echo "- **$(basename $apk)** (${SIZE} bytes)" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "## âŒ No APKs generated" >> $GITHUB_STEP_SUMMARY
          fi