name: ğŸš€ Stable APK Builder

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type to create'
        required: false
        default: 'both'
        type: choice
        options:
          - debug
          - release
          - both
      force_clean:
        description: 'Force clean build (ignore cache)'
        required: false
        default: false
        type: boolean

env:
  # Stable versions to ensure reproducible builds
  JAVA_VERSION: '17'
  GRADLE_VERSION: '8.4'
  # Build optimization settings
  GRADLE_OPTS: '-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2 -Dorg.gradle.parallel=false'
  # Network timeout settings
  GRADLE_USER_HOME: ${{ github.workspace }}/.gradle

jobs:
  # Pre-build validation to catch issues early
  validation:
    name: ğŸ” Pre-build Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better validation

      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@v1

      - name: Check file permissions
        run: |
          chmod +x gradlew
          ls -la gradlew

      - name: Validate build files
        run: |
          echo "âœ… Checking build.gradle files..."
          if [ ! -f "build.gradle" ]; then
            echo "âŒ Root build.gradle not found"
            exit 1
          fi
          if [ ! -f "app/build.gradle" ]; then
            echo "âŒ App build.gradle not found"
            exit 1
          fi
          echo "âœ… All build files present"

      - name: Check source code structure
        run: |
          echo "âœ… Validating source code structure..."
          if [ ! -d "app/src/main/java" ] && [ ! -d "app/src/main/kotlin" ]; then
            echo "âŒ No source directory found"
            exit 1
          fi
          echo "âœ… Source structure valid"

  # Stable build job with comprehensive error handling
  build:
    name: ğŸ—ï¸ Build APK
    runs-on: ubuntu-latest
    needs: validation
    timeout-minutes: 45
    
    strategy:
      fail-fast: false
      matrix:
        build_type: 
          - debug
          - release
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          check-latest: true

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: 34.0.0
          ndk-version: 25.2.9519653

      - name: ğŸ—‚ï¸ Cache Gradle dependencies
        uses: actions/cache@v4
        if: ${{ !github.event.inputs.force_clean }}
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            .gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ğŸ§¹ Clean workspace (if force clean)
        if: ${{ github.event.inputs.force_clean == 'true' }}
        run: |
          echo "ğŸ—‘ï¸ Force cleaning workspace..."
          rm -rf ~/.gradle/caches
          rm -rf .gradle
          ./gradlew clean --no-daemon

      - name: ğŸ“‹ Prepare build environment
        run: |
          echo "ğŸ“Š System Information:"
          echo "Java version: $(java -version 2>&1 | head -1)"
          echo "Available memory: $(free -h)"
          echo "Available disk space: $(df -h .)"
          echo "CPU cores: $(nproc)"
          
          # Ensure gradlew is executable
          chmod +x gradlew
          
          # Create directories if they don't exist
          mkdir -p app/build/outputs/apk/debug
          mkdir -p app/build/outputs/apk/release

      - name: ğŸ” Validate dependencies (with retries)
        run: |
          echo "ğŸ”„ Validating dependencies with retry mechanism..."
          for i in {1..3}; do
            echo "Attempt $i/3..."
            if ./gradlew dependencies --no-daemon --stacktrace; then
              echo "âœ… Dependencies validated successfully"
              break
            else
              if [ $i -eq 3 ]; then
                echo "âŒ Failed to validate dependencies after 3 attempts"
                exit 1
              fi
              echo "â³ Retrying in 30 seconds..."
              sleep 30
            fi
          done

      - name: ğŸ§ª Run unit tests
        run: |
          echo "ğŸ§ª Running unit tests..."
          ./gradlew testDebugUnitTest --no-daemon --stacktrace --continue || echo "âš ï¸ Some tests failed, continuing..."

      - name: ğŸ”¨ Build ${{ matrix.build_type }} APK (with retries)
        run: |
          echo "ğŸ”¨ Building ${{ matrix.build_type }} APK with retry mechanism..."
          for i in {1..3}; do
            echo "Build attempt $i/3..."
            if [ "${{ matrix.build_type }}" == "debug" ]; then
              BUILD_COMMAND="./gradlew assembleDebug --no-daemon --stacktrace"
            else
              BUILD_COMMAND="./gradlew assembleRelease --no-daemon --stacktrace"
            fi
            
            if $BUILD_COMMAND; then
              echo "âœ… ${{ matrix.build_type }} APK built successfully"
              break
            else
              if [ $i -eq 3 ]; then
                echo "âŒ Failed to build APK after 3 attempts"
                echo "ğŸ“‹ Gradle daemon status:"
                ./gradlew --status || true
                echo "ğŸ“‹ Build scan info:"
                echo "Check the logs above for detailed error information"
                exit 1
              fi
              echo "â³ Cleaning and retrying in 60 seconds..."
              ./gradlew clean --no-daemon || true
              sleep 60
            fi
          done

      - name: ğŸ“Š Collect build information
        id: build_info
        run: |
          echo "ğŸ“Š Collecting build information..."
          
          # Get version information
          VERSION_NAME=$(grep -o 'versionName "[^"]*' app/build.gradle | sed 's/versionName "//' || echo "1.0.0")
          VERSION_CODE=$(grep -o 'versionCode [0-9]*' app/build.gradle | sed 's/versionCode //' || echo "1")
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          COMMIT_SHA=${GITHUB_SHA:0:7}
          
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ Build Info:"
          echo "Version: $VERSION_NAME ($VERSION_CODE)"
          echo "Built at: $BUILD_TIME"
          echo "Commit: $COMMIT_SHA"

      - name: ğŸ·ï¸ Rename and organize APK files
        run: |
          echo "ğŸ·ï¸ Organizing APK files..."
          
          BUILD_TYPE="${{ matrix.build_type }}"
          VERSION_NAME="${{ steps.build_info.outputs.version_name }}"
          COMMIT_SHA="${{ steps.build_info.outputs.commit_sha }}"
          BUILD_TIME=$(date +%Y%m%d_%H%M)
          
          # Create organized output directory
          mkdir -p organized_outputs
          
          if [ "$BUILD_TYPE" == "debug" ]; then
            APK_PATH="app/build/outputs/apk/debug"
            for apk in $APK_PATH/*.apk; do
              if [ -f "$apk" ]; then
                NEW_NAME="SpadeAce-v${VERSION_NAME}-${BUILD_TIME}-${COMMIT_SHA}-debug.apk"
                cp "$apk" "organized_outputs/$NEW_NAME"
                echo "âœ… Created: $NEW_NAME"
                
                # Generate checksums
                cd organized_outputs
                sha256sum "$NEW_NAME" > "${NEW_NAME}.sha256"
                md5sum "$NEW_NAME" > "${NEW_NAME}.md5"
                cd ..
              fi
            done
          else
            APK_PATH="app/build/outputs/apk/release"
            for apk in $APK_PATH/*.apk; do
              if [ -f "$apk" ]; then
                NEW_NAME="SpadeAce-v${VERSION_NAME}-${BUILD_TIME}-${COMMIT_SHA}-release.apk"
                cp "$apk" "organized_outputs/$NEW_NAME"
                echo "âœ… Created: $NEW_NAME"
                
                # Generate checksums
                cd organized_outputs
                sha256sum "$NEW_NAME" > "${NEW_NAME}.sha256"
                md5sum "$NEW_NAME" > "${NEW_NAME}.md5"
                cd ..
              fi
            done
          fi

      - name: ğŸ” Verify APK integrity
        run: |
          echo "ğŸ” Verifying APK integrity..."
          for apk in organized_outputs/*.apk; do
            if [ -f "$apk" ]; then
              echo "Checking: $(basename $apk)"
              
              # Check file size
              SIZE=$(stat -f%z "$apk" 2>/dev/null || stat -c%s "$apk" 2>/dev/null || echo "0")
              if [ "$SIZE" -lt 1000000 ]; then # Less than 1MB is suspicious
                echo "âš ï¸ Warning: APK size is only ${SIZE} bytes"
              else
                echo "âœ… APK size: ${SIZE} bytes"
              fi
              
              # Verify it's a valid ZIP file (APKs are ZIP files)
              if file "$apk" | grep -q "Zip archive"; then
                echo "âœ… APK is a valid ZIP archive"
              else
                echo "âŒ APK is not a valid ZIP archive"
                exit 1
              fi
              
              # Try to list contents
              if unzip -l "$apk" > /dev/null 2>&1; then
                echo "âœ… APK structure is valid"
              else
                echo "âŒ APK structure is invalid"
                exit 1
              fi
            fi
          done

      - name: ğŸ“¤ Upload APK artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: SpadeAce-${{ matrix.build_type }}-APK-${{ steps.build_info.outputs.version_name }}
          path: |
            organized_outputs/*.apk
            organized_outputs/*.sha256
            organized_outputs/*.md5
          retention-days: 90
          if-no-files-found: error

      - name: ğŸ“Š Upload build reports (on failure)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: build-reports-${{ matrix.build_type }}-${{ github.run_number }}
          path: |
            app/build/reports/
            app/build/outputs/logs/
          retention-days: 14
          if-no-files-found: ignore

  # Post-build analysis and summary
  summary:
    name: ğŸ“‹ Build Summary
    runs-on: ubuntu-latest
    needs: build
    if: always()
    timeout-minutes: 5

    steps:
      - name: ğŸ“Š Generate build summary
        run: |
          echo "# ğŸš€ Stable APK Builder - Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“… Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check job results
          echo "## ğŸ¯ Job Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ needs.validation.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Debug | ${{ contains(needs.build.result, 'success') && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Release | ${{ contains(needs.build.result, 'success') && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "## ğŸ‰ Build Successful!" >> $GITHUB_STEP_SUMMARY
            echo "âœ… All APKs built successfully and are ready for download." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“¦ Available Artifacts:" >> $GITHUB_STEP_SUMMARY
            echo "- Debug APK with checksums" >> $GITHUB_STEP_SUMMARY
            echo "- Release APK with checksums" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "Some jobs failed. Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by Stable APK Builder v1.0*" >> $GITHUB_STEP_SUMMARY

  # Notification job (optional, can be customized)
  notify:
    name: ğŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: [validation, build, summary]
    if: always() && github.event_name == 'push'
    timeout-minutes: 2
    
    steps:
      - name: ğŸ“¢ Build notification
        run: |
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "ğŸ‰ Stable APK Builder completed successfully!"
            echo "âœ… All APKs are ready for download from the Actions tab."
          else
            echo "âŒ Stable APK Builder failed."
            echo "Please check the build logs for details."
          fi